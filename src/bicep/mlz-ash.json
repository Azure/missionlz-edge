{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1008.15138",
      "templateHash": "14710604161060505543"
    }
  },
  "parameters": {
    "hubResourceGroupName": {
      "type": "string",
      "defaultValue": "[format('{0}-hub', parameters('resourcePrefix'))]"
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "uniqueId": {
      "type": "string",
      "defaultValue": "[uniqueString(deployment().name)]"
    },
    "resourcePrefix": {
      "type": "string",
      "defaultValue": "[format('mlz-{0}', parameters('uniqueId'))]"
    },
    "tags": {
      "type": "object",
      "defaultValue": {}
    },
    "nowUtc": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    },
    "hubVirtualNetworkName": {
      "type": "string",
      "defaultValue": "hub-vnet"
    },
    "hubVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.90.0.0/16"
    },
    "mgmtSubnetName": {
      "type": "string",
      "defaultValue": "mgmt"
    },
    "mgmtSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.90.0.0/24"
    },
    "extSubnetName": {
      "type": "string",
      "defaultValue": "external"
    },
    "extSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.90.1.0/24"
    },
    "intSubnetName": {
      "type": "string",
      "defaultValue": "internal"
    },
    "intSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.90.2.0/24"
    },
    "vdmsSubnetName": {
      "type": "string",
      "defaultValue": "vdms"
    },
    "vdmsSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.90.3.0/24"
    },
    "hubNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "hub-nsg"
    },
    "hubNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": [
        {
          "name": "allow_SSH",
          "properties": {
            "description": "Allows SSH traffic",
            "protocol": "Tcp",
            "sourcePortRange": "*",
            "destinationPortRange": "22",
            "sourceAddressPrefix": "*",
            "destinationAddressPrefix": "*",
            "access": "Allow",
            "priority": 100,
            "direction": "Inbound"
          }
        },
        {
          "name": "allow_RDP",
          "properties": {
            "description": "Allows SSH traffic",
            "protocol": "Tcp",
            "sourcePortRange": "*",
            "destinationPortRange": "3389",
            "sourceAddressPrefix": "*",
            "destinationAddressPrefix": "*",
            "access": "Allow",
            "priority": 120,
            "direction": "Inbound"
          }
        }
      ]
    },
    "f5VmAuthenticationType": {
      "type": "string",
      "defaultValue": "password",
      "allowedValues": [
        "sshPublicKey",
        "password"
      ]
    },
    "f5VmAdminPasswordOrKey": {
      "type": "secureString",
      "minLength": 14
    },
    "f5VmAdminUsername": {
      "type": "string",
      "defaultValue": "f5admin"
    },
    "f5VmOsDiskCreateOption": {
      "type": "string",
      "defaultValue": "FromImage"
    },
    "f5VmOsDiskType": {
      "type": "string",
      "defaultValue": "Premium_LRS"
    },
    "f5VmImagePublisher": {
      "type": "string",
      "defaultValue": "f5-networks"
    },
    "f5VmImageOffer": {
      "type": "string",
      "defaultValue": "f5-big-ip-best"
    },
    "f5VmImageSku": {
      "type": "string",
      "defaultValue": "f5-bigip-virtual-edition-best-byol"
    },
    "f5VmImageVersion": {
      "type": "string",
      "defaultValue": "14.0.001000"
    },
    "f5VmSize": {
      "type": "string",
      "defaultValue": "Standard_DS3_v2"
    },
    "f5extSubnetName": {
      "type": "string",
      "defaultValue": "external"
    },
    "f5intSubnetName": {
      "type": "string",
      "defaultValue": "internal"
    },
    "f5mgmtSubnetName": {
      "type": "string",
      "defaultValue": "mgmt"
    },
    "f5privateIPAddressAllocationMethod": {
      "type": "string",
      "defaultValue": "Dynamic"
    },
    "f5vm01extIpConfigurationName": {
      "type": "string",
      "defaultValue": "f5vm01extIpConfiguration"
    },
    "f5vm01extNicName": {
      "type": "string",
      "defaultValue": "[format('{0}-f5vm01-ext-nic', parameters('resourcePrefix'))]"
    },
    "f5vm01intIpConfigurationName": {
      "type": "string",
      "defaultValue": "f5vm01intIpConfiguration"
    },
    "f5vm01intNicName": {
      "type": "string",
      "defaultValue": "[format('{0}-f5vm01-int-nic', parameters('resourcePrefix'))]"
    },
    "f5vm01mgmtIpConfigurationName": {
      "type": "string",
      "defaultValue": "f5vm01mgmtIpConfiguration"
    },
    "f5vm01mgmtNicName": {
      "type": "string",
      "defaultValue": "[format('{0}-f5vm01-mgmt-nic', parameters('resourcePrefix'))]"
    }
  },
  "functions": [],
  "variables": {
    "defaultTags": {
      "resourcePrefix": "[parameters('resourcePrefix')]",
      "DeploymentType": "MissionLandingZoneARM"
    },
    "calculatedTags": "[union(parameters('tags'), variables('defaultTags'))]",
    "hubSubnets": [
      {
        "name": "[parameters('mgmtSubnetName')]",
        "properties": {
          "addressPrefix": "[parameters('mgmtSubnetAddressPrefix')]"
        }
      },
      {
        "name": "[parameters('intSubnetName')]",
        "properties": {
          "addressPrefix": "[parameters('intSubnetAddressPrefix')]"
        }
      },
      {
        "name": "[parameters('extSubnetName')]",
        "properties": {
          "addressPrefix": "[parameters('extSubnetAddressPrefix')]"
        }
      },
      {
        "name": "[parameters('vdmsSubnetName')]",
        "properties": {
          "addressPrefix": "[parameters('vdmsSubnetAddressPrefix')]"
        }
      }
    ],
    "f5vm01VmName": "[format('{0}-f5vm01', parameters('resourcePrefix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-rg-hub-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('hubResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('calculatedTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "16793551366393102966"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2019-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "location": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-vnet-hub-{0}', parameters('nowUtc'))]",
      "resourceGroup": "[parameters('hubResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('hubVirtualNetworkName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "addressPrefix": {
            "value": "[parameters('hubVirtualNetworkAddressPrefix')]"
          },
          "subnets": {
            "value": "[variables('hubSubnets')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "4423030218172085734"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "addressPrefix": {
              "type": "string"
            },
            "subnets": {
              "type": "array"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2018-11-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('addressPrefix')]"
                  ]
                },
                "subnets": "[parameters('subnets')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
            },
            "subnets": {
              "type": "array",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-hub-{0}', parameters('nowUtc')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-nsg-hub-{0}', parameters('nowUtc'))]",
      "resourceGroup": "[parameters('hubResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[parameters('hubNetworkSecurityGroupName')]"
          },
          "securityRules": {
            "value": "[parameters('hubNetworkSecurityGroupRules')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "17850607432557549000"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "securityRules": {
              "type": "array"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2018-11-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": "[parameters('securityRules')]"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-hub-{0}', parameters('nowUtc')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-f5vm01-hub-{0}', parameters('nowUtc'))]",
      "resourceGroup": "[parameters('hubResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminPasswordOrKey": {
            "value": "[parameters('f5VmAdminPasswordOrKey')]"
          },
          "adminUsername": {
            "value": "[parameters('f5VmAdminUsername')]"
          },
          "authenticationType": {
            "value": "[parameters('f5VmAuthenticationType')]"
          },
          "extIpConfigurationName": {
            "value": "[parameters('f5vm01extIpConfigurationName')]"
          },
          "extNicName": {
            "value": "[parameters('f5vm01extNicName')]"
          },
          "extPrivateIPAddressAllocationMethod": {
            "value": "[parameters('f5privateIPAddressAllocationMethod')]"
          },
          "extSubnetName": {
            "value": "[parameters('f5extSubnetName')]"
          },
          "intIpConfigurationName": {
            "value": "[parameters('f5vm01intIpConfigurationName')]"
          },
          "intNicName": {
            "value": "[parameters('f5vm01intNicName')]"
          },
          "intPrivateIPAddressAllocationMethod": {
            "value": "[parameters('f5privateIPAddressAllocationMethod')]"
          },
          "intSubnetName": {
            "value": "[parameters('f5intSubnetName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mgmtIpConfigurationName": {
            "value": "[parameters('f5vm01mgmtIpConfigurationName')]"
          },
          "mgmtNicName": {
            "value": "[parameters('f5vm01mgmtNicName')]"
          },
          "mgmtPrivateIPAddressAllocationMethod": {
            "value": "[parameters('f5privateIPAddressAllocationMethod')]"
          },
          "mgmtSubnetName": {
            "value": "[parameters('f5mgmtSubnetName')]"
          },
          "networkSecurityGroupId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-nsg-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.id.value]"
          },
          "nowUtc": {
            "value": "[parameters('nowUtc')]"
          },
          "osDiskCreateOption": {
            "value": "[parameters('f5VmOsDiskCreateOption')]"
          },
          "virtualNetworkName": {
            "value": "[parameters('hubVirtualNetworkName')]"
          },
          "vmName": {
            "value": "[variables('f5vm01VmName')]"
          },
          "vmOsDiskType": {
            "value": "[parameters('f5VmOsDiskType')]"
          },
          "vmImageOffer": {
            "value": "[parameters('f5VmImageOffer')]"
          },
          "vmImagePublisher": {
            "value": "[parameters('f5VmImagePublisher')]"
          },
          "vmImageSku": {
            "value": "[parameters('f5VmImageSku')]"
          },
          "vmImageVersion": {
            "value": "[parameters('f5VmImageVersion')]"
          },
          "vmSize": {
            "value": "[parameters('f5VmSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "8497323553010622726"
            }
          },
          "parameters": {
            "nowUtc": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "networkSecurityGroupId": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string",
              "defaultValue": "password",
              "allowedValues": [
                "sshPublicKey",
                "password"
              ]
            },
            "adminPasswordOrKey": {
              "type": "secureString",
              "minLength": 14
            },
            "adminUsername": {
              "type": "string"
            },
            "osDiskCreateOption": {
              "type": "string"
            },
            "vmName": {
              "type": "string"
            },
            "vmOsDiskType": {
              "type": "string"
            },
            "vmImageOffer": {
              "type": "string"
            },
            "vmImagePublisher": {
              "type": "string"
            },
            "vmImageSku": {
              "type": "string"
            },
            "vmImageVersion": {
              "type": "string"
            },
            "vmSize": {
              "type": "string"
            },
            "extIpConfigurationName": {
              "type": "string"
            },
            "extNicName": {
              "type": "string"
            },
            "extPrivateIPAddressAllocationMethod": {
              "type": "string"
            },
            "extSubnetName": {
              "type": "string"
            },
            "intIpConfigurationName": {
              "type": "string"
            },
            "intNicName": {
              "type": "string"
            },
            "intPrivateIPAddressAllocationMethod": {
              "type": "string"
            },
            "intSubnetName": {
              "type": "string"
            },
            "mgmtIpConfigurationName": {
              "type": "string"
            },
            "mgmtNicName": {
              "type": "string"
            },
            "mgmtPrivateIPAddressAllocationMethod": {
              "type": "string"
            },
            "mgmtSubnetName": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "[format('create-ext-nic-{0}', parameters('nowUtc'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ipConfigurationName": {
                    "value": "[parameters('extIpConfigurationName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[parameters('extNicName')]"
                  },
                  "networkSecurityGroupId": {
                    "value": "[parameters('networkSecurityGroupId')]"
                  },
                  "privateIPAddressAllocationMethod": {
                    "value": "[parameters('extPrivateIPAddressAllocationMethod')]"
                  },
                  "subnetId": {
                    "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('extSubnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('extSubnetName')), '/')[1])]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "6520784676685160060"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "ipConfigurationName": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "networkSecurityGroupId": {
                      "type": "string"
                    },
                    "privateIPAddressAllocationMethod": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "[parameters('ipConfigurationName')]",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "privateIPAllocationMethod": "[parameters('privateIPAddressAllocationMethod')]"
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[parameters('networkSecurityGroupId')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "[format('create-int-nic-{0}', parameters('nowUtc'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ipConfigurationName": {
                    "value": "[parameters('intIpConfigurationName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[parameters('intNicName')]"
                  },
                  "networkSecurityGroupId": {
                    "value": "[parameters('networkSecurityGroupId')]"
                  },
                  "privateIPAddressAllocationMethod": {
                    "value": "[parameters('intPrivateIPAddressAllocationMethod')]"
                  },
                  "subnetId": {
                    "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('intSubnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('intSubnetName')), '/')[1])]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "6520784676685160060"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "ipConfigurationName": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "networkSecurityGroupId": {
                      "type": "string"
                    },
                    "privateIPAddressAllocationMethod": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "[parameters('ipConfigurationName')]",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "privateIPAllocationMethod": "[parameters('privateIPAddressAllocationMethod')]"
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[parameters('networkSecurityGroupId')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "[format('create-mgmt-nic-{0}', parameters('nowUtc'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ipConfigurationName": {
                    "value": "[parameters('mgmtIpConfigurationName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[parameters('mgmtNicName')]"
                  },
                  "networkSecurityGroupId": {
                    "value": "[parameters('networkSecurityGroupId')]"
                  },
                  "privateIPAddressAllocationMethod": {
                    "value": "[parameters('mgmtPrivateIPAddressAllocationMethod')]"
                  },
                  "subnetId": {
                    "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('mgmtSubnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('mgmtSubnetName')), '/')[1])]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "6520784676685160060"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "ipConfigurationName": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "networkSecurityGroupId": {
                      "type": "string"
                    },
                    "privateIPAddressAllocationMethod": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "[parameters('ipConfigurationName')]",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "privateIPAllocationMethod": "[parameters('privateIPAddressAllocationMethod')]"
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[parameters('networkSecurityGroupId')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "[format('create-f5vm-{0}', parameters('nowUtc'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPasswordOrKey": {
                    "value": "[parameters('adminPasswordOrKey')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "authenticationType": {
                    "value": "[parameters('authenticationType')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[parameters('vmName')]"
                  },
                  "networkInterfaces": {
                    "value": [
                      {
                        "id": "[reference(resourceId('Microsoft.Resources/deployments', format('create-mgmt-nic-{0}', parameters('nowUtc'))), '2020-06-01').outputs.id.value]",
                        "properties": {
                          "primary": true
                        }
                      },
                      {
                        "id": "[reference(resourceId('Microsoft.Resources/deployments', format('create-ext-nic-{0}', parameters('nowUtc'))), '2020-06-01').outputs.id.value]",
                        "properties": {
                          "primary": false
                        }
                      },
                      {
                        "id": "[reference(resourceId('Microsoft.Resources/deployments', format('create-int-nic-{0}', parameters('nowUtc'))), '2020-06-01').outputs.id.value]",
                        "properties": {
                          "primary": false
                        }
                      }
                    ]
                  },
                  "osDiskCreateOption": {
                    "value": "[parameters('osDiskCreateOption')]"
                  },
                  "osDiskType": {
                    "value": "[parameters('vmOsDiskType')]"
                  },
                  "vmImageOffer": {
                    "value": "[parameters('vmImageOffer')]"
                  },
                  "vmImagePublisher": {
                    "value": "[parameters('vmImagePublisher')]"
                  },
                  "vmImageSku": {
                    "value": "[parameters('vmImageSku')]"
                  },
                  "vmImageVersion": {
                    "value": "[parameters('vmImageVersion')]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "12954575830243579965"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "networkInterfaces": {
                      "type": "array"
                    },
                    "vmSize": {
                      "type": "string"
                    },
                    "osDiskCreateOption": {
                      "type": "string"
                    },
                    "osDiskType": {
                      "type": "string"
                    },
                    "vmImagePublisher": {
                      "type": "string"
                    },
                    "vmImageOffer": {
                      "type": "string"
                    },
                    "vmImageSku": {
                      "type": "string"
                    },
                    "vmImageVersion": {
                      "type": "string"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "authenticationType": {
                      "type": "string",
                      "allowedValues": [
                        "sshPublicKey",
                        "password"
                      ]
                    },
                    "adminPasswordOrKey": {
                      "type": "secureString",
                      "minLength": 14
                    }
                  },
                  "functions": [],
                  "variables": {
                    "osProfile": {
                      "sshPublicKey": {
                        "computerName": "[parameters('name')]",
                        "adminUsername": "[parameters('adminUsername')]",
                        "linuxConfiguration": {
                          "disablePasswordAuthentication": true,
                          "ssh": {
                            "publicKeys": [
                              {
                                "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                "keyData": "[parameters('adminPasswordOrKey')]"
                              }
                            ]
                          }
                        }
                      },
                      "password": {
                        "computerName": "[parameters('name')]",
                        "adminUsername": "[parameters('adminUsername')]",
                        "adminPassword": "[parameters('adminPasswordOrKey')]"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "osDisk": {
                            "createOption": "[parameters('osDiskCreateOption')]",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            }
                          },
                          "imageReference": {
                            "publisher": "[parameters('vmImagePublisher')]",
                            "offer": "[parameters('vmImageOffer')]",
                            "sku": "[parameters('vmImageSku')]",
                            "version": "[parameters('vmImageVersion')]"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": "[parameters('networkInterfaces')]"
                        },
                        "osProfile": "[variables('osProfile')[parameters('authenticationType')]]"
                      }
                    }
                  ],
                  "outputs": {
                    "adminUsername": {
                      "type": "string",
                      "value": "[parameters('adminUsername')]"
                    },
                    "authenticationType": {
                      "type": "string",
                      "value": "[parameters('authenticationType')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('create-ext-nic-{0}', parameters('nowUtc')))]",
                "[resourceId('Microsoft.Resources/deployments', format('create-int-nic-{0}', parameters('nowUtc')))]",
                "[resourceId('Microsoft.Resources/deployments', format('create-mgmt-nic-{0}', parameters('nowUtc')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-nsg-hub-{0}', parameters('nowUtc')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-hub-{0}', parameters('nowUtc')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('nowUtc')))]"
      ]
    }
  ]
}